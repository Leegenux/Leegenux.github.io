<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Win32 Reverse Engineering Basics | Evan&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="This post consists of my learning notes, insights, my experience of cracking a executable as well as answers to the assignments.We are using OllyDbg to crack. Primary Usages of OllyDbgKeyboard Shortcu">
<meta property="og:type" content="article">
<meta property="og:title" content="Win32 Reverse Engineering Basics">
<meta property="og:url" content="https://leegenux.xyz/2019/03/28/win32-reverse-engineering-basics/index.html">
<meta property="og:site_name" content="Evan&#39;s Blog">
<meta property="og:description" content="This post consists of my learning notes, insights, my experience of cracking a executable as well as answers to the assignments.We are using OllyDbg to crack. Primary Usages of OllyDbgKeyboard Shortcu">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://ws3.sinaimg.cn/large/005BYqpgly1g1ilhjin0aj30iy0bvgls.jpg">
<meta property="og:image" content="https://ws3.sinaimg.cn/large/005BYqpgly1g1im1uk8lrj30im0brwer.jpg">
<meta property="og:image" content="https://ws3.sinaimg.cn/large/005BYqpgly1g1im4pztg2j30im0bz74p.jpg">
<meta property="og:image" content="https://ws3.sinaimg.cn/large/005BYqpgly1g1im87ylenj30iv03v0sp.jpg">
<meta property="og:image" content="https://ws3.sinaimg.cn/large/005BYqpgly1g1imhjl4j4j30ik0870ss.jpg">
<meta property="article:published_time" content="2019-03-28T06:36:33.000Z">
<meta property="article:modified_time" content="2023-01-24T01:37:34.713Z">
<meta property="article:author" content="Evan Lee">
<meta property="article:tag" content="win32">
<meta property="article:tag" content="pe">
<meta property="article:tag" content="reverse">
<meta property="article:tag" content="crack">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://ws3.sinaimg.cn/large/005BYqpgly1g1ilhjin0aj30iy0bvgls.jpg">
  
    <link rel="alternate" href="/atom.xml" title="Evan's Blog" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Evan&#39;s Blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://leegenux.xyz"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-win32-reverse-engineering-basics" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/03/28/win32-reverse-engineering-basics/" class="article-date">
  <time class="dt-published" datetime="2019-03-28T06:36:33.000Z" itemprop="datePublished">2019-03-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      Win32 Reverse Engineering Basics
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>This post consists of my learning notes, insights, my experience of cracking a executable as well as answers to the assignments.<br>We are using OllyDbg to crack.</p>
<h2 id="Primary-Usages-of-OllyDbg"><a href="#Primary-Usages-of-OllyDbg" class="headerlink" title="Primary Usages of OllyDbg"></a>Primary Usages of OllyDbg</h2><h3 id="Keyboard-Shortcuts"><a href="#Keyboard-Shortcuts" class="headerlink" title="Keyboard Shortcuts"></a>Keyboard Shortcuts</h3><p>With these 4 shortcuts, we are able to do some reverse engineering on easy crackmes like one that I’m gonna show you.</p>
<ul>
<li><strong>Restart</strong>			  <code>Ctrl</code> + <code>F2</code></li>
<li><strong>Step Into</strong> 		 <code>F7</code></li>
<li><strong>Step Over</strong> 		  <code>F8</code></li>
<li><strong>Execute till Return</strong> 	 <code>Ctrl </code>+ <code>F9</code></li>
</ul>
<h3 id="Ways-to-Modify-Strings-in-Binaries"><a href="#Ways-to-Modify-Strings-in-Binaries" class="headerlink" title="Ways to Modify Strings in Binaries"></a>Ways to Modify Strings in Binaries</h3><ul>
<li>Direct modification : That’s directly making changes in the <strong>Disassembler Window</strong>.</li>
<li>Create a new string somewhere else and make it work instead of the original one.</li>
</ul>
<blockquote>
<p>To know more details about the user interface. Refer to <a target="_blank" rel="noopener" href="https://www.oreilly.com/library/view/practical-malware-analysis/9781593272906/ch10s02.html">here</a></p>
</blockquote>
<p>Two points above reveals two fundamental approaches of patching a binary. The patch mentioned are both intuitively achievable in terms of OllyDbg’s software operations. </p>
<p>What need to be emphasized is that we shouldn’t forget to save our changes to the binary.</p>
<h2 id="IA32-Registers"><a href="#IA32-Registers" class="headerlink" title="IA32 Registers"></a>IA32 Registers</h2><h3 id="Register-Types"><a href="#Register-Types" class="headerlink" title="Register Types"></a>Register Types</h3><ul>
<li>General purpose registers</li>
<li>Segment registers</li>
<li>Program status and control registers</li>
<li>Instruction pointer registers</li>
</ul>
<h2 id="Stack-Establishment-and-Destruction"><a href="#Stack-Establishment-and-Destruction" class="headerlink" title="Stack Establishment and Destruction"></a>Stack Establishment and Destruction</h2><p>The routine of conventional Win32 programs regarding stack’s establishment and destruction can be elaborated in a simple way:</p>
<ol>
<li>push EBP to store the old stack base value</li>
<li>mov EBP, ESP to create a brand new stack for subprogram</li>
</ol>
<p>And the destruction is quite the opposite.</p>
<h2 id="Important-Information-About-Cracking-VB-Binaries"><a href="#Important-Information-About-Cracking-VB-Binaries" class="headerlink" title="Important Information About Cracking VB Binaries"></a>Important Information About Cracking VB Binaries</h2><ul>
<li>VB program can be compiled into P code(<strong>Pseudo Code</strong>) or N code(<strong>Native code</strong>)</li>
<li>VB program operates in an event-driven manner, in which Windows mainly works.</li>
<li>VB program’s fundamental information resides in the executables in the form of structures.</li>
</ul>
<h2 id="X86-Calling-Conventions"><a href="#X86-Calling-Conventions" class="headerlink" title="X86 Calling Conventions"></a>X86 Calling Conventions</h2><ul>
<li><strong>cdecl</strong> </li>
<li><strong>stdcall</strong></li>
<li><strong>fastcall</strong></li>
</ul>
<p>The <code>cdecl</code> features callers’ responsibility to clean up the callee’s stack which makes calling with mutable amount of parameters possible. And <code>stdcall</code> works differently. The callee clears the stack so that the program have better compatibility against other languages. So Win32 development chooses the latter convention. There are also <code>fastcall</code> which makes use of registers for faster calling (However things don’t always act as expected).</p>
<h2 id="PE-File-Format"><a href="#PE-File-Format" class="headerlink" title="PE File Format"></a>PE File Format</h2><p>Portable Executables are known as PE file. There are essential information across different aspects including memory location, compatibility code, CPU family etc stored in the header part of the PE file. You can check them out by clicking <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/desktop/debug/pe-format">here</a>. Also I will upload a post containing the important points later.</p>
<h2 id="Hands-on-Cracking"><a href="#Hands-on-Cracking" class="headerlink" title="Hands-on Cracking"></a>Hands-on Cracking</h2><p>The test executable can be downloaded <a href="">here</a></p>
<h3 id="Find-the-Main-Function"><a href="#Find-the-Main-Function" class="headerlink" title="Find the Main Function"></a>Find the Main Function</h3><p>Before debugging, you should first take a glance at what this file is about. It turns out that a password is required or you are blocked. Then load the file with debugger. Do stepping over until you see the prompt: <code>What&#39;s your password?</code>. You are already in the <code>main</code> function. Trace back and at some point you see this: <img src="https://ws3.sinaimg.cn/large/005BYqpgly1g1ilhjin0aj30iy0bvgls.jpg"></p>
<p>The <code>CALL</code> statement jumps to the “ask for password” section. Around it there are <code>MSVCR120.__winitenv</code> and <code>MSVCR120.exit</code> API calls. So we can assure that this is the <code>main</code> function entry.</p>
<h3 id="Crack-the-Password-Section"><a href="#Crack-the-Password-Section" class="headerlink" title="Crack the Password Section"></a>Crack the Password Section</h3><p>After the password <code>scanf</code> related code. There are lines</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">TEST EAX, EAX</span><br><span class="line">JE SHORT Test1.011C419</span><br></pre></td></tr></table></figure>

<p>implementing the logic that when two string matches, jump to <code>Test1.011C419</code>. Here <code>EAX</code> is set to 0 when function <code>strcmp</code> finds two strings match.</p>
<p><code>TEST</code> sets the zero flag, <code>ZF</code>, when the result of the <code>AND</code> operation is 0. So only if <code>EAX</code> is 0 will <code>JE</code> statement do the jump.</p>
<p>To bypass the password, try changing them into this:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CMP EAX, EAX</span><br><span class="line">JE SHORT Test1.011C419</span><br></pre></td></tr></table></figure>

<p>This modification makes the <code>JE</code> statement directly jumps to the <code>string matches</code> logic branch. Save and rerun, you now get to the next stage.</p>
<h3 id="Reveal-the-Encryption"><a href="#Reveal-the-Encryption" class="headerlink" title="Reveal the Encryption"></a>Reveal the Encryption</h3><p>The second input in the format of <code>%d</code> is stored on the <code>SS:[EBP-48]</code> and a least significant byte in the <code>EAX</code> as what this screenshot tells us:</p>
<p><img src="https://ws3.sinaimg.cn/large/005BYqpgly1g1im1uk8lrj30im0brwer.jpg"></p>
<p>Execution of <code>CALL Test1.011C11A4</code> leads us to the initiation of an array:</p>
<p><img src="https://ws3.sinaimg.cn/large/005BYqpgly1g1im4pztg2j30im0bz74p.jpg"></p>
<p>After that there is a loop where the encryption goes:</p>
<p><img src="https://ws3.sinaimg.cn/large/005BYqpgly1g1im87ylenj30iv03v0sp.jpg"></p>
<p>Procedures above can be translated into fake code:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">unsigned char offset = last_byte_of(input_code); 	// Get the input</span><br><span class="line"></span><br><span class="line">init(array);     // Init the code</span><br><span class="line"></span><br><span class="line">for (char i = 0; i&lt;length(array); i++) &#123;</span><br><span class="line">    array[i] = array[i] xor array[i+offset];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Store-the-Decryped-Code"><a href="#Store-the-Decryped-Code" class="headerlink" title="Store the Decryped Code"></a>Store the Decryped Code</h3><p>The screenshot shows all necessary information:</p>
<p><img src="https://ws3.sinaimg.cn/large/005BYqpgly1g1imhjl4j4j30ik0870ss.jpg"></p>
<p>The decrypted code are stored in the <code>D:\kp</code>. (Though I changed it because I don’t have no drive with label D).</p>
<h2 id="Assignments-and-Answers"><a href="#Assignments-and-Answers" class="headerlink" title="Assignments and Answers"></a>Assignments and Answers</h2><h3 id="What’s-the-Calling-Convention-of-this-executable"><a href="#What’s-the-Calling-Convention-of-this-executable" class="headerlink" title="What’s the Calling Convention of this executable ?"></a>What’s the Calling Convention of this executable ?</h3><p>As you can see, there are no steps of clearing stack right behind the <code>CALL</code>. According to the description in the <strong>X86 Calling Conventions</strong> section several paragraphs away above . It uses <code>stdcall</code>. Registers play no part in passing parameters to callee.</p>
<h3 id="What-API-does-the-program-calls-when-storing-the-decrypted-data"><a href="#What-API-does-the-program-calls-when-storing-the-decrypted-data" class="headerlink" title="What API does the program calls when storing the decrypted data ?"></a>What API does the program calls when storing the decrypted data ?</h3><p>Obviously according to the image: <code>KERNEL32.CreateFileA</code>, <code>KERNEL32.WriteFile</code> and <code>KERNEL32.CloseHandle</code> are used.</p>
<h3 id="Where-is-the-main-entry-and-how-is-the-code-decrypted"><a href="#Where-is-the-main-entry-and-how-is-the-code-decrypted" class="headerlink" title="Where is the main entry and how is the code decrypted ?"></a>Where is the <code>main</code> entry and how is the code decrypted ?</h3><p>Both described concisely in the post.</p>
<h3 id="Write-a-PE-header-scanner"><a href="#Write-a-PE-header-scanner" class="headerlink" title="Write a PE header scanner ?"></a>Write a PE header scanner ?</h3><p>There are references all around the web. My solution will be like <a target="_blank" rel="noopener" href="https://github.com/Arvanaghi/PE-Parser">this one</a>.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://leegenux.xyz/2019/03/28/win32-reverse-engineering-basics/" data-id="cld9kj0c8001g7swk75cs3iqx" data-title="Win32 Reverse Engineering Basics" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/crack/" rel="tag">crack</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pe/" rel="tag">pe</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/reverse/" rel="tag">reverse</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/win32/" rel="tag">win32</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2019/04/07/lengthOfLongestSubstring/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Algorithm Practice --- Length Of Longest Substring Containing No Repetitive Characters.
        
      </div>
    </a>
  
  
    <a href="/2019/03/20/ubuntu-nextcloud-configuration/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Ubuntu 18.04 NextCloud Installation Guide</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/" rel="tag">C</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PIC32/" rel="tag">PIC32</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PIC32MX/" rel="tag">PIC32MX</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/algorithm/" rel="tag">algorithm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/apache/" rel="tag">apache</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/awk/" rel="tag">awk</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/bash/" rel="tag">bash</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/crack/" rel="tag">crack</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cracking/" rel="tag">cracking</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cut/" rel="tag">cut</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dll/" rel="tag">dll</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/embeded/" rel="tag">embeded</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/" rel="tag">hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/" rel="tag">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nextcloud/" rel="tag">nextcloud</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nginx-ssl-https-static-website-letsencrypt-certbot/" rel="tag">nginx, ssl, https, static website, letsencrypt, certbot</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/paste/" rel="tag">paste</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pe/" rel="tag">pe</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/reverse/" rel="tag">reverse</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/shell/" rel="tag">shell</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/socket/" rel="tag">socket</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sort/" rel="tag">sort</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tr/" rel="tag">tr</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ubuntu/" rel="tag">ubuntu</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/uniq/" rel="tag">uniq</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/win32/" rel="tag">win32</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/C/" style="font-size: 10px;">C</a> <a href="/tags/PIC32/" style="font-size: 10px;">PIC32</a> <a href="/tags/PIC32MX/" style="font-size: 10px;">PIC32MX</a> <a href="/tags/algorithm/" style="font-size: 10px;">algorithm</a> <a href="/tags/apache/" style="font-size: 10px;">apache</a> <a href="/tags/awk/" style="font-size: 10px;">awk</a> <a href="/tags/bash/" style="font-size: 15px;">bash</a> <a href="/tags/crack/" style="font-size: 10px;">crack</a> <a href="/tags/cracking/" style="font-size: 10px;">cracking</a> <a href="/tags/cut/" style="font-size: 10px;">cut</a> <a href="/tags/dll/" style="font-size: 10px;">dll</a> <a href="/tags/embeded/" style="font-size: 10px;">embeded</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/linux/" style="font-size: 20px;">linux</a> <a href="/tags/nextcloud/" style="font-size: 10px;">nextcloud</a> <a href="/tags/nginx-ssl-https-static-website-letsencrypt-certbot/" style="font-size: 10px;">nginx, ssl, https, static website, letsencrypt, certbot</a> <a href="/tags/paste/" style="font-size: 10px;">paste</a> <a href="/tags/pe/" style="font-size: 12.5px;">pe</a> <a href="/tags/reverse/" style="font-size: 10px;">reverse</a> <a href="/tags/shell/" style="font-size: 17.5px;">shell</a> <a href="/tags/socket/" style="font-size: 10px;">socket</a> <a href="/tags/sort/" style="font-size: 10px;">sort</a> <a href="/tags/tr/" style="font-size: 10px;">tr</a> <a href="/tags/ubuntu/" style="font-size: 10px;">ubuntu</a> <a href="/tags/uniq/" style="font-size: 10px;">uniq</a> <a href="/tags/win32/" style="font-size: 12.5px;">win32</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/01/">January 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/01/24/Deployment-of-Static-Sites-with-Nginx/">Deployment of Static Sites with Nginx and Certbot</a>
          </li>
        
          <li>
            <a href="/2023/01/24/Introduction-to-Hexo-Blog-Framework/">Introduction to Hexo Blog Framework</a>
          </li>
        
          <li>
            <a href="/2023/01/24/understanding-pe-format/">Basics of PE Format(1)</a>
          </li>
        
          <li>
            <a href="/2023/01/24/usage%20of%20derper%20and%20certbot/">Configuration of Tailscale Derper and Certbot</a>
          </li>
        
          <li>
            <a href="/2019/07/06/PIC32-configuration/">PIC32MX Basics --- Basic Configuration</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2023 Evan Lee<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>